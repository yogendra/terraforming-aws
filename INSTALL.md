# Install PKS

## Pre-requisite

- Use an Ubuntu jumpbox initialize with [my script][pcf-jumpbox]. It will install all tools (git/curl/bosh/om/pivnet/etc)
- All instruction should be run on this jumpbox
- Log in to pivnet

## (Optional) Setup mkcert

If you are going to use self-signed certs, I recommend using `mkcert`. It sets up a local Root CA and creates all certs signed by that CA. This way you do not need to worry about copying ca certs in trust store or something.

## Install PKS on AWS

1.  Clone this repository into a project directory. Lets call it project root.

    ```bash
    git clone https://github.com/yogendra/terraforming-aws.git demo
    ```

1.  Go to the cloned derectory

    ```bash
    cd demo
    ```

1.  Think about domain suffix (runs-on.cf) and (demo)

1.  Create SSL certs

    - Use Lets Encrypt
      ```bash
      WIP
      ```
    - **OR** Use self signed certificates generated by mkcert

      ```bash
      mkcert \
          -cert-file ssl-certificate.pem \
          -key-file ssl-private-key.pem \
          demo.aws.yogendra.me \
          \*.demo.aws.yogendra.me \
          \*.pks.demo.aws.yogendra.me \
          \*.system.demo.aws.yogendra.me \
          \*.system-k8s.demo.aws.yogendra.me \
          \*.devops.demo.aws.yogendra.me \
          \*.devops-k8s.demo.aws.yogendra.me \
          \*.apps.demo.aws.yogendra.me \
          \*.apps-k8s.demo.aws.yogendra.me
      ```

1.  Go to `terraformming-pks`

    ```bash
    cd terraforming-pks
    ```

1.  Prepare `terraform.tfvar` as below:

    ```yaml
    env_name = "demo"

    access_key = "YOUR-AWS-ACCESS-KEY"

    secret_key = "YOUR-AWS-SECRET-KEY"

    region = "us-east-1"

    availability_zones = ["us-east-1a"]

    # Goto https://network.pivotal.io/products/ops-manager
    # Download "Ops Manager YAML for AWS - ...."
    # Find the correct ami for your region
    ops_manager_ami = "ami-0aac5f23906ab0036"

    dns_suffix = "runs-on.cf"

    vpc_cidr = "10.0.0.0/16"

    use_route53 = true

    enable_harbor = true

    ssl_cert = <<EOF
    PUT YOUR CERTIFICATE HERE HERE
    On Mac Copy using : cat ../ssl-certificate.pem | pbcopy
    EOF

    ssl_private_key = <<EOF
    PUT YOUR PRIVATE KEY HERE
    On Mac Copy using : cat ../ssl-private-key.pem | pbcopy
    EOF

    tags = {
    "Environment"    = "Demo"
    }
    ```

1.  Initialize terraform

    ```bash
    terraform init
    ```

1.  Prepare plan

    ```bash
    terraform plan -out create.tfplan
    ```

1.  Apply plan

    ```bash
    terraform apply create.tfplan
    ```

1.  Update DNS

    - If your parent domain is on Google

      1.  Set GCP_DNS_ZONE_NAME environement variable

          ```bash
          export GCP_DNS_ZONE_NAME=runs-on-cf-zone
          ```

      1.  Set PCF_DOMAIN environment variable

          ```bash
          export PCF_DOMAIN=$(terraform output ops_manager_dns | sed 's/^pcf.//')
          echo "export PCF_DOMAIN=$PCF_DOMAIN" > ../.env-pcf
          ```

      1.  Configure parent hosted zone to point to new subdomain zone

          ```bash
          gcloud dns record-sets transaction start --zone=$GCP_DNS_ZONE_NAME
          gcloud dns record-sets transaction add $(terraform output env_dns_zone_name_servers | sed 's/,$//;s/\.$/$/;s/$/./' | tr "\n" " ") --name=${PCF_DOMAIN}. --ttl=300 --type=NS --zone=$
          gcloud dns record-sets transaction execute --zone=$GCP_DNS_ZONE_NAME
          ```

    - **OR** If parent domain is hosted on AWS
      ```
      WIP
      ```
    - **OR** If parent domain is hosted on Azure
      ```
      WIP
      ```

1.  Export Ops Manager key

    ```bash
    terraform output ops_manager_ssh_private_key > ../om.key
    chmod 600 ../om.key
    ```

1.  Goto project root

    ```bash
    cd ..
    ```

1.  Prepare environement file `.env-pcf`

    ```bash
    export PCF_DOMAIN=demo.runs-on.cf

    export PCF_IAAS=aws
    export PCF_TILES_DIR=$PWD

    export OM_TARGET=pcf.$PCF_DOMAIN
    export OM_SKIP_SSL_VALIDATION=true
    export OM_USERNAME=admin
    export OM_PASSWORD=CHANGE_ME
    export OM_DECRYPTION_PASSPHRASE=$OM_PASSWORD
    export OM_KEY=$PWD/om.key
    export BOSH_ALL_PROXY="ssh+socks5://ubuntu@$OM_TARGET:22?private-key=$OM_KEY"
    [[ -e $PWD/.env-bosh ]] && source $PWD/.env-bosh
    ```

1.  Load pcf envrionment file

    ```bash
    source .env-pcf
    ```

1.  If you are using self-signed cert (mkcert), set the CA_CERT environment variable before proceeding. This will add it as a trusted CA on all VMs.

    ```
    export CA_CERT="$(cat "`mkcert -CAROOT`/rootCA.pem")"
    ```

1.  Configure Director


    ```bash
    scripts/configure-director terraforming-pks $OM_PASSWORD
    ```

1.  Update Ops Manager SSL Certificate

    ```bash
    om update-ssl-certificate --certificate-pem "$(< ssl-certificate.pem)" --private-key-pem "$(< ssl-private-key.pem)"
    ```

1.  Create VM extension for pks

    ```bash
    om -k create-vm-extension -n pks-api-lb-security-groups -cp '{ "security_groups": ["pks_api_lb_security_group"] }'
    ```

1.  Create VM extension for harbor

    ```bash
    om -k create-vm-extension -n harbor-lb-security-groups -cp "{ \"security_groups\": [\"harbor_lb_security_group\"] }"
    ```

1.  Uplod PKS

    ```bash
    pivnet dlpf
    scrips/om-install pivotal-container-service \*pivotal 1.6.1
    ```

1.  Stage PKS

    ```bash
    om stage-product -p pivotal-container-service -v 1.6.1-build.6
    ```

1.  Configure PKS

    ```bash
    scripts/configure-product terraforming-pks pks $OM_PASSWORD
    ```

1.  Upload Harbor

    ```bash
    scripts/om-install harbor-container-registry \*pivotal 1.10.1
    ```

1.  Stage Harbor

    ```bash
    om stage-product -p harbor-container-registry -v 1.10.1-build.7
    ```

1.  Configure Harbor

    ```bash
    scripts/configure-product terraforming-pks harbor $OM_PASSWORD
    ```

1.  Apply Changes

    ```bash
    om apply-changes
    ```

[pcf-jumpbox]: https://github.com/yogendra/dotfiles/blob/master/scripts/pcf-jumpbox-init.sh
